{extend name="public:index"/}

{block name="main"}

<section class="content-wrapper right-side" id="riframe" style="margin:0;padding:0;margin-left:30px;">
    <iframe id='rightContent' name='rightContent' src="{:url('Demo/index')}" width='100%' frameborder="0"
            scrolling="atuo"></iframe>
</section>
<link rel="stylesheet" type="text/css" href="/public/im/font_Icon/iconfont.css">
<link rel="stylesheet" type="text/css" href="/public/im/css/chat.css">
<script src="__PUBLIC__/plugins/jQuery/jquery-2.2.3.min.js"></script>
<script src="//cdn.ronghub.com/RongIMLib-2.3.3.min.js"></script>
<div class="chatContainer">
    <div class="chatBtn">
        <i class="iconfont icon-xiaoxi1"></i>
    </div>
    <div class="chat-message-num">10</div>
    <div class="chatBox" ref="chatBox">
        <div class="chatBox-head">
            <div class="chatBox-head-one">
                Conversations
                <div class="chat-close" style="margin: 10px 10px 0 0;font-size: 14px">关闭</div>
            </div>
            <div class="chatBox-head-two">
                <div class="chat-return">返回</div>
                <div class="chat-people">
                    <div class="ChatInfoHead">
                        <img src="" alt="头像"/>
                    </div>
                    <div class="ChatInfoName">这是用户的名字，看看名字到底能有多长</div>
                </div>
                <div class="chat-close">关闭</div>
            </div>
        </div>
        <div class="chatBox-info">
            <div class="chatBox-list" ref="chatBoxlist">
                <div class="chat-list-people">
                    <div><img src="/public/im/img/icon01.png" alt="头像"/></div>
                    <div class="chat-name">
                        <p>自酌一杯酒</p>
                    </div>
                    <div class="message-num">10</div>
                </div>
                <div class="chat-list-people">
                    <div><img src="/public/im/img/icon02.png" alt="头像"/></div>
                    <div class="chat-name">
                        <p>白兰地</p>
                    </div>
                    <div class="message-num">8</div>
                </div>
                <div class="chat-list-people">
                    <div><img src="/public/im/img/icon03.png" alt="头像"/></div>
                    <div class="chat-name">
                        <p>威士忌</p>
                    </div>
                    <div class="message-num">2</div>
                </div>
                <div class="chat-list-people">
                    <div><img src="/public/im/img/icon01.png" alt="头像"/></div>
                    <div class="chat-name">
                        <p>荷兰金酒</p>
                    </div>
                    <div class="message-num">20</div>
                </div>
                <div class="chat-list-people">
                    <div><img src="/public/im/img/icon03.png" alt="头像"/></div>
                    <div class="chat-name">
                        <p>朗姆酒</p>
                    </div>
                    <div class="message-num">10</div>
                </div>
                <div class="chat-list-people">
                    <div><img src="/public/im/img/icon02.png" alt="头像"/></div>
                    <div class="chat-name">
                        <p>特其拉酒</p>
                    </div>
                    <div class="message-num">18</div>
                </div>
                <div class="chat-list-people">
                    <div><img src="/public/im/img/icon02.png" alt="头像"/></div>
                    <div class="chat-name">
                        <p>鸡尾酒</p>
                    </div>
                    <div class="message-num">9</div>
                </div>
                <div class="chat-list-people">
                    <div><img src="/public/im/img/icon01.png" alt="头像"/></div>
                    <div class="chat-name">
                        <p>虎骨酒</p>
                    </div>
                    <div class="message-num">12</div>
                </div>
                <div class="chat-list-people">
                    <div><img src="/public/im/img/icon01.png" alt="头像"/></div>
                    <div class="chat-name">
                        <p>琴酒</p>
                    </div>
                    <div class="message-num">99+</div>
                </div>
                <div class="chat-list-people">
                    <div><img src="/public/im/img/icon02.png" alt="头像"/></div>
                    <div class="chat-name">
                        <p>葡萄酒</p>
                    </div>
                    <div class="message-num"></div>
                </div>
                <div class="chat-list-people">
                    <div><img src="/public/im/img/icon01.png" alt="头像"/></div>
                    <div class="chat-name">
                        <p>蓝莓酒</p>
                    </div>
                    <div class="message-num"></div>
                </div>
                <div class="chat-list-people">
                    <div><img src="/public/im/img/icon03.png" alt="头像"/></div>
                    <div class="chat-name">
                        <p>樱花酒</p>
                    </div>
                    <div class="message-num"></div>
                </div>
            </div>
            <div class="chatBox-kuang" ref="chatBoxkuang">
                <div class="chatBox-content">
                    <div class="chatBox-content-demo" id="chatBox-content-demo">

                        <div class="clearfloat">
                            <div class="author-name">
                                <small class="chat-date">2017-12-02 14:26:58</small>
                            </div>
                            <div class="left">
                                <div class="chat-avatars"><img src="/public/im/img/icon01.png" alt="头像"/></div>
                                <div class="chat-message">
                                    给你看张图
                                </div>
                            </div>
                        </div>

                        <div class="clearfloat">
                            <div class="author-name">
                                <small class="chat-date">2017-12-02 14:26:58</small>
                            </div>
                            <div class="left">
                                <div class="chat-avatars"><img src="/public/im/img/icon01.png" alt="头像"/></div>
                                <div class="chat-message">
                                    <img src="/public/im/img/1.png" alt="">
                                </div>
                            </div>
                        </div>

                        <div class="clearfloat">
                            <div class="author-name">
                                <small class="chat-date">2017-12-02 14:26:58</small>
                            </div>
                            <div class="right">
                                <div class="chat-message">嗯，适合做壁纸</div>
                                <div class="chat-avatars"><img src="/public/im/img/icon02.png" alt="头像"/></div>
                            </div>
                        </div>
                        <div class="clearfloat">
                            <div class="author-name">
                                <small class="chat-date">2017-12-02 14:26:58</small>
                            </div>
                            <div class="right">
                                <div class="chat-message">嗯，适合做壁纸</div>
                                <div class="chat-avatars"><img src="/public/im/img/icon02.png" alt="头像"/></div>
                            </div>
                        </div>
                        <div class="clearfloat">
                            <div class="author-name">
                                <small class="chat-date">2017-12-02 14:26:58</small>
                            </div>
                            <div class="right">
                                <div class="chat-message">嗯，适合做壁纸</div>
                                <div class="chat-avatars"><img src="/public/im/img/icon02.png" alt="头像"/></div>
                            </div>
                        </div>
                        <div class="clearfloat">
                            <div class="author-name">
                                <small class="chat-date">2017-12-02 14:26:58</small>
                            </div>
                            <div class="right">
                                <div class="chat-message">嗯，适合做壁纸</div>
                                <div class="chat-avatars"><img src="/public/im/img/icon02.png" alt="头像"/></div>
                            </div>
                        </div>
                        <div class="clearfloat">
                            <div class="author-name">
                                <small class="chat-date">2017-12-02 14:26:58</small>
                            </div>
                            <div class="right">
                                <div class="chat-message">嗯，适合做壁纸</div>
                                <div class="chat-avatars"><img src="/public/im/img/icon02.png" alt="头像"/></div>
                            </div>
                        </div>
                        <div class="clearfloat">
                            <div class="author-name">
                                <small class="chat-date">2017-12-02 14:26:58</small>
                            </div>
                            <div class="right">
                                <div class="chat-message">嗯，适合做壁纸</div>
                                <div class="chat-avatars"><img src="/public/im/img/icon02.png" alt="头像"/></div>
                            </div>
                        </div>

                    </div>
                </div>
                <div class="chatBox-send">
                    <div class="div-textarea" contenteditable="true"></div>
                    <div>
                        <button id="chat-biaoqing" class="btn-default-styles">
                            <i class="iconfont icon-biaoqing"></i>
                        </button>
                        <label id="chat-tuxiang" title="发送图片" for="inputImage" class="btn-default-styles">
                            <input type="file" onchange="selectImg(this)" accept="image/jpg,image/jpeg,image/png"
                                   name="file" id="inputImage" class="hidden">
                            <i class="iconfont icon-tuxiang"></i>
                        </label>
                        <button id="chat-fasong" class="btn-default-styles"><i class="iconfont icon-fasong"></i>
                        </button>
                    </div>
                    <div class="biaoqing-photo">
                        <ul>
                            <li><span class="emoji-picker-image" style="background-position: -9px -18px;"></span></li>
                            <li><span class="emoji-picker-image" style="background-position: -40px -18px;"></span></li>
                            <li><span class="emoji-picker-image" style="background-position: -71px -18px;"></span></li>
                            <li><span class="emoji-picker-image" style="background-position: -102px -18px;"></span></li>
                            <li><span class="emoji-picker-image" style="background-position: -133px -18px;"></span></li>
                            <li><span class="emoji-picker-image" style="background-position: -164px -18px;"></span></li>
                            <li><span class="emoji-picker-image" style="background-position: -9px -52px;"></span></li>
                            <li><span class="emoji-picker-image" style="background-position: -40px -52px;"></span></li>
                            <li><span class="emoji-picker-image" style="background-position: -71px -52px;"></span></li>
                            <li><span class="emoji-picker-image" style="background-position: -102px -52px;"></span></li>
                            <li><span class="emoji-picker-image" style="background-position: -133px -52px;"></span></li>
                            <li><span class="emoji-picker-image" style="background-position: -164px -52px;"></span></li>
                            <li><span class="emoji-picker-image" style="background-position: -9px -86px;"></span></li>
                            <li><span class="emoji-picker-image" style="background-position: -40px -86px;"></span></li>
                            <li><span class="emoji-picker-image" style="background-position: -71px -86px;"></span></li>
                            <li><span class="emoji-picker-image" style="background-position: -102px -86px;"></span></li>
                            <li><span class="emoji-picker-image" style="background-position: -133px -86px;"></span></li>
                            <li><span class="emoji-picker-image" style="background-position: -164px -86px;"></span></li>
                            <li><span class="emoji-picker-image" style="background-position: -9px -120px;"></span></li>
                            <li><span class="emoji-picker-image" style="background-position: -40px -120px;"></span></li>
                            <li><span class="emoji-picker-image" style="background-position: -71px -120px;"></span></li>
                            <li><span class="emoji-picker-image" style="background-position: -102px -120px;"></span>
                            </li>
                            <li><span class="emoji-picker-image" style="background-position: -133px -120px;"></span>
                            </li>
                            <li><span class="emoji-picker-image" style="background-position: -164px -120px;"></span>
                            </li>
                            <li><span class="emoji-picker-image" style="background-position: -9px -154px;"></span></li>
                            <li><span class="emoji-picker-image" style="background-position: -40px -154px;"></span></li>
                            <li><span class="emoji-picker-image" style="background-position: -71px -154px;"></span></li>
                            <li><span class="emoji-picker-image" style="background-position: -102px -154px;"></span>
                            </li>
                            <li><span class="emoji-picker-image" style="background-position: -133px -154px;"></span>
                            </li>
                            <li><span class="emoji-picker-image" style="background-position: -164px -154px;"></span>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    var params = {
        appKey :"{:config('rongyun.appKey')}",
        token : "{$r_token}",
    };
    console.log(params);
    var callbacks = {

    };

    var targetId = "xiaosong"; // 目标 Id
    var msg = new RongIMLib.TextMessage({content:"hello RongCloud!",extra:"附加信息"});
    function sendMessage(msg) {
        RongIMClient.getInstance().sendMessage(RongIMLib.ConversationType.PRIVATE, targetId, msg, {
            // 发送消息成功
            onSuccess: function (message) {
                console.log('onMessage:');
                console.log(message);
                // // var extra = message.content.extra;
                // var extra = eval('(' + message.content.extra + ')');
                // //console.log(message);
                // if(message.messageType != "PersonMessage"&& message.messageType != "ImageMessage"){
                //
                //     if(status == 1){
                //         var str = '<p class="live-msg mg_top10"><span class="blue">'+extra.nick_name+':</span>'+message.content.content+' </p>';
                //         $('.live-chate').append(str);
                //         $(".live-chate").scrollTop($(".live-chate")[0].scrollHeight);
                //     }else{
                //         var str = '<div class="padding_10 mg_top10"><div class="clearfix text-center"><dl class="clearfix left width_100"><dt class="right"><img class="head" src="'+extra.header_img+'"></dt><dd class="right padding_lr10"><p class="text_right"><strong>'+extra.nick_name+'</strong></p><p class="mg_top5">'+message.content.content+'</p></dd></dl></div></div>';
                //         $('.msg-chat').append(str);
                //         $(".msg-chat").scrollTop($(".msg-chat")[0].scrollHeight);
                //     }
                //     var div="<div>"+message.content.content+"</div>";
                //     $(".d_show").append(div);
                //     init_screen();
                // }else{
                //     if (status == 1) {
                //         var str = '<p class="live-msg mg_top10"><i class="xi">系</i><span class="blue">'+extra.nick_name+'</span> 进入直播间<img class="vertical-align_m" src="__IMG2__/msg_hores.png" alt="" /></p>';
                //         $('.live-chate').append(str);
                //         $(".live-chate").scrollTop($(".live-chate")[0].scrollHeight);
                //     }
                // }
                // if(message.messageType == "ImageMessage"){
                //     var extra = message.content.user;
                //     // var extra = message.content.extra;
                //     if(status == 1){
                //         var str = '<img src="'+message.content.imageUri+'">';
                //         $('.live-chate').append(str);
                //         $(".live-chate").scrollTop($(".live-chate")[0].scrollHeight);
                //     }else{
                //         var str = '<div class="padding_10 mg_top10"><div class="clearfix text-center"><dl class="clearfix left width_100"><dt class="right"><img class="head" src="'+extra.portrait+'"></dt><dd class="right padding_lr10"><p class="text_right"><strong>'+extra.name+'</strong></p><p class="mg_top5"><img style="max-width: 200px" src="'+message.content.imageUri+'"></p></dd></dl></div></div>';
                //         $('.msg-chat').append(str);
                //         $(".msg-chat").scrollTop($(".msg-chat")[0].scrollHeight);
                //     }
                // }

                // getMessage(message);
                //message 为发送的消息对象并且包含服务器返回的消息唯一Id和发送消息时间戳
                // //console.log("Send successfully");
            },
            onError: function (errorCode, message) {
                var info = '';
                switch (errorCode) {
                    case RongIMLib.ErrorCode.TIMEOUT:
                        info = '超时';
                        break;
                    case RongIMLib.ErrorCode.UNKNOWN_ERROR:
                        info = '未知错误';
                        break;
                    case RongIMLib.ErrorCode.REJECTED_BY_BLACKLIST:
                        info = '在黑名单中，无法向对方发送消息';
                        break;
                    case RongIMLib.ErrorCode.NOT_IN_DISCUSSION:
                        info = '不在讨论组中';
                        break;
                    case RongIMLib.ErrorCode.NOT_IN_GROUP:
                        info = '不在群组中';
                        break;
                    case RongIMLib.ErrorCode.NOT_IN_CHATROOM:
                        info = '不在聊天室中';
                        break;
                    default:
                        info = "x";
                        break;
                }
                //console.log('发送失败:' + info);
            }
        });
    }


    init(params,callbacks);
    function init(params, callbacks, modules){
        var appKey = params.appKey;
        var token = params.token;
        var navi = params.navi || "";

        modules = modules || {};
        var RongIMLib = modules.RongIMLib || window.RongIMLib;
        var RongIMClient = RongIMLib.RongIMClient;
        var protobuf = modules.protobuf || null;

        var config = {};

        //私有云切换navi导航，私有云格式 '120.92.10.214:8888'
        if(navi !== ""){
            config.navi = navi;
        }

        //私有云切换api,私有云格式 '172.20.210.38:81:8888'
        var api = params.api || "";
        if(api !== ""){
            config.api = api;
        }

        //support protobuf url + function
        if(protobuf != null){
            config.protobuf = protobuf;
        };


        RongIMLib.RongIMClient.init(appKey,null,config);
        var messageName = "PersonMessage"; // 消息名称。
        var objectName = "RC:Welcome"; // 消息内置名称，请按照此格式命名。
        var mesasgeTag = new RongIMLib.MessageTag(true,true);// 消息是否保存是否计数，true true 保存且计数，false false 不保存不计数。
        var prototypes = ["content","extra"]; // 消息类中的属性名。
        RongIMClient.registerMessageType(messageName,objectName,mesasgeTag,prototypes);
        //
        // /*
        //  文档：http://www.rongcloud.cn/docs/web.html#3、设置消息监听器
        //
        //  注意事项：
        //  1：为了看到接收效果，需要另外一个用户向本用户发消息
        //  2：判断会话唯一性 ：conversationType + targetId
        //  3：显示消息在页面前，需要判断是否属于当前会话，避免消息错乱。
        //  4：消息体属性说明可参考：http://rongcloud.cn/docs/api/js/index.html
        //  */


        var instance = RongIMClient.getInstance();

        // 连接状态监听器
        RongIMClient.setConnectionStatusListener({
            onChanged: function (status) {

                // //console.log(status);
                switch (status) {
                    case RongIMLib.ConnectionStatus["CONNECTED"]:
                    case 0:
                        // //console.log("连接成功")
                        callbacks.getInstance && callbacks.getInstance(instance);
                        break;

                    case RongIMLib.ConnectionStatus["CONNECTING"]:
                    case 1:
                        // //console.log("连接中")
                        break;

                    case RongIMLib.ConnectionStatus["DISCONNECTED"]:
                    case 2:
                        // //console.log("当前用户主动断开链接")
                        break;

                    case RongIMLib.ConnectionStatus["NETWORK_UNAVAILABLE"]:
                    case 3:
                        // //console.log("网络不可用")
                        break;

                    case RongIMLib.ConnectionStatus["CONNECTION_CLOSED"]:
                    case 4:
                        // //console.log("未知原因，连接关闭")
                        break;

                    case RongIMLib.ConnectionStatus["KICKED_OFFLINE_BY_OTHER_CLIENT"]:
                    case 6:
                        // //console.log("用户账户在其他设备登录，本机会被踢掉线")
                        break;

                    case RongIMLib.ConnectionStatus["DOMAIN_INCORRECT"]:
                    case 12:
                        // //console.log("当前运行域名错误，请检查安全域名配置")
                        break;
                }
            }
        });
        function escapeJquery(srcString) {
            var escapseResult = srcString;

            var reg = new RegExp("<[^<]*>", "gi");
            escapseResult = escapseResult.replace(reg, "");
            // console.log(escapseResult)
            return escapseResult;
        };


        //融云开始连接
        RongIMClient.connect(token, {
            onSuccess: function(userId) {
                callbacks.getCurrentUser && callbacks.getCurrentUser({userId:userId});
                console.log("链接成功，用户id：" + userId);
                RongIMClient.getInstance().getConversationList({
                    onSuccess: function(list) {
                        var i = 0;
                        setInterval(
                            function () {
                                i++;

                                if (i >= 2){
                                    return false;
                                }

                                var str = "小兰="+i;
                                var extra = new Object();
                                extra.nick_name = "{$userInfo.nick_name}";
                                extra.header_img = "{$userInfo.header_img}";
                                var msg = new RongIMLib.ImageMessage({
                                    content:'',
                                    // imageUri:"",
                                    extra:JSON.stringify(extra),
                                });
                                sendMessage(msg);
                            },300
                        );






                        //
                        // var str = "小兰发送给小松的消息测试追加789789789";
                        // var extra = new Object();
                        // extra.role_id = "xiaosong";
                        // extra.nick_name = "小白蛇";
                        // extra.header_img = "http://daike.xingzhuosong.com/public/upload/images/20181029/d9c6ec4ddffaf1b2cc5da5b398f587ba.jpg";
                        // var msg = new RongIMLib.TextMessage({
                        //     content: escapeJquery(str),
                        //     extra:JSON.stringify(extra),
                        // });
                        // sendMessage(msg);

                        console.log(list);
                        // list => 会话列表集合。
                    },
                    onError: function(error) {
                        // do something...
                    }
                },null);

            },
            onTokenIncorrect: function() {
                //console.log('token无效');
            },
            onError:function(errorCode){
                //console.log(errorCode);
            }
        });}

    // 发送消息相关参数说明
    var conversationtype = RongIMLib.ConversationType.CHATROOM;
    /*
    PRIVATE 为单聊、
    GROUP 为群组、
    CHATROOM 为聊天室、
    CUSTOMER_SERVICE 为客服、
    SYSTEM 为系统消息、
    APP_PUBLIC_SERVICE 为应用公众账号（应用内私有）、
    PUBLIC_SERVICE 为公众账号 (公有)
    */

    RongIMClient.setOnReceiveMessageListener({
        // 接收到的消息
        onReceived: function(message) {

            // 判断消息类型
            console.log('messageContent:');

            console.log(message);

            switch (message.messageType) {
                case RongIMClient.MessageType.TextMessage:
                    // //console.log(message.content.content)
                    // //console.log('yyyy');
                    var extra = eval('(' + message.content.extra + ')');
                    // var extra = message.content.extra;
                    if(status == 1){
                        var str = '<p class="live-msg mg_top10"><span class="blue">'+extra.nick_name+':</span>'+message.content.content+' </p>';
                        $('.live-chate').append(str);
                        $(".live-chate").scrollTop($(".live-chate")[0].scrollHeight);
                    }else{

                        if(extra == undefined){
                            extra = new Object();

                            extra.nick_name = message.content.user.name;
                            extra.header_img = message.content.user.portrait;
                        }
                        var str = '<div class="padding_10 mg_top10"><div class="clearfix"><dl class="clearfix left"><dt class="left"><img class="head" src="'+extra.header_img+'"></dt><dd class="left padding_lr10"><p><strong>'+extra.nick_name+'</strong></p><p class="mg_top5">'+message.content.content+'</p></dd></dl></div></div>';
                        //发送的消息内容将会被打印
                        $('.msg-chat').append(str);
                        $(".msg-chat").scrollTop($(".msg-chat")[0].scrollHeight);
                    }

                    // answers(message.content.content,message.senderUserId);
                    break;
                case RongIMClient.MessageType.ImageMessage:
                    var extra = message.content.user;
                    // var extra = message.content.extra;
                    if(status == 1){
                        var str = '<img src="'+message.content.imageUri+'">';
                        $('.live-chate').append(str);
                        $(".live-chate").scrollTop($(".live-chate")[0].scrollHeight);
                    }else{
                        var str = '<div class="padding_10 mg_top10"><div class="clearfix"><dl class="clearfix left"><dt class="left"><img class="head" src="'+extra.portrait+'"></dt><dd class="left padding_lr10"><p><strong>'+extra.name+'</strong></p><p class="mg_top5"><img style="max-width: 200px" src="'+message.content.imageUri+'"></p></dd></dl></div></div>';
                        $('.msg-chat').append(str);
                        $(".msg-chat").scrollTop($(".msg-chat")[0].scrollHeight);
                    }
                    // do something...
                    break;
                case RongIMClient.MessageType.DiscussionNotificationMessage:

                    // do something...
                    break;
                case RongIMClient.MessageType.LocationMessage:

                    // do something...
                    break;
                case RongIMClient.MessageType.RichContentMessage:

                    // do something...
                    break;
                case RongIMClient.MessageType.DiscussionNotificationMessage:

                    // do something...
                    break;
                case RongIMClient.MessageType.InformationNotificationMessage:
                    // do something...
                    break;
                case RongIMClient.MessageType.ContactNotificationMessage:
                    // do something...
                    break;
                case RongIMClient.MessageType.ProfileNotificationMessage:
                    // do something...
                    break;
                case RongIMClient.MessageType.CommandNotificationMessage:
                    // do something...
                    break;
                case RongIMClient.MessageType.CommandMessage:
                    // do something...
                    break;
                case RongIMClient.MessageType.UnknownMessage:
                    var str = '';
                    if(status == 1){
                        if(message. senderUserId== 'system'){
                            if(message.content.message.content.content.type == 'gift' ){
                                if ((gift_status != 1)) return false;
                                var st = '';
                                for(var i=0;i<message.content.message.content.content.data.num.length;i++){
                                    st += '<img src="__IMG2__/'+message.content.message.content.content.data.num[i]+'.png"/>';
                                }
                                str = '<p class="padding_10"><img class="bg_gife" style="width: 36px;" src="'+message.content.message.content.content.data.img+'"/><img  src="__IMG2__/x.png"/>'+st+'</p>';
                                $(".gife").html(str);
                                $(".gife").css('display','block');
                                $('.gife').addClass('animated slideInRight');
                                setTimeout(function(){
                                    $('.gife').removeClass('slideInRight');

                                }, 1000);
                                $('.gife').delay(1000).fadeOut(200);
                                return false;
                            }else if(message.content.message.content.content.type == 'red_package'){
                                if ((system_status != 1)) return false;
                                str = '<p class="live-msg mg_top10"><i class="xi">系</i>'+message.content.message.content.content.data.role_name+'发出了一个红包 <img class="vertical-align_m" id="red" src="__IMG2__/msg_redbag.png" alt=""  onclick="getredPackage(this)" data-id="'+message.content.message.content.content.data.red_id+'" data-name="'+message.content.message.content.content.data.role_name+'" data-type="'+message.content.message.content.content.data.red_type+'" data-img="'+message.content.message.content.content.data.header_img+'"/></p>';
                            }else if(message.content.message.content.content.type == 'guess'){
                                if ((system_status != 1)) return false;
                                str = '<p class="live-msg mg_top10"><i class="xi">系</i><span class="green">房主发起了一次竞猜</span><img class="vertical-align_m" src="__IMG2__/msg_tv.png" alt="" /></p>';
                            }else if(message.content.message.content.content.type == 'system'){
                                if ((system_status != 1)) return false;
                                str = '<p class="live-msg mg_top10"><i class="xi">系</i><span class="green">'+message.content.message.content.content.data+'</span><img class="vertical-align_m" src="__IMG2__/msg_tv.png" alt="" /></p>';

                            }else if(message.content.message.content.content.type == 'close'){
                                if(is_owner != 1) {
                                    layer.msg('主播已关闭直播,2s后将跳转至聊天室,是否立刻跳转?', {
                                        time: 0 //不自动关闭
                                        , btn: ['确定']
                                        , yes: function (index) {
                                            // layer.close(index);
                                            history.go(0);
                                        }
                                    });
                                    setTimeout(function () {
                                        history.go(0);
                                    }, 2000);
                                }else{
                                    history.go(0);
                                }
                            }else if(message.content.message.content.content.type == 'ban'){
                                if(is_owner != 1 && is_admin != 1){
                                    $(".s_txt").attr("readonly","readonly");
                                    $(".s_txt").attr("placeholder","禁言中");
                                    $(".s_txt").remove("id");
                                    $(".play_msg").attr("readonly","readonly");
                                    $(".play_msg").attr("placeholder","禁言中");
                                    $(".play_msg").remove("id");
                                    $(".send_btn").remove("id");
                                    $(".send_btn1").remove("id");
                                }
                            }else if(message.content.message.content.content.type == 'remove'){
                                if(is_owner != 1 && is_admin != 1){
                                    $(".s_txt").removeAttr("readonly");
                                    $(".s_txt").attr("placeholder","");
                                    $(".s_txt").attr("id",'dm_msg');
                                    $(".play_msg").attr("readonly","none");
                                    $(".play_msg").attr("placeholder","");
                                    $(".play_msg").attr("id",'msg');
                                    $(".send_btn").attr("id",'send');
                                    $(".send_btn1").attr("id",'dm_send');
                                }
                            }

                            if(str != ''){
                                $(".live-chate").append(str);
                                $(".live-chate").scrollTop($(".live-chate")[0].scrollHeight);
                            }
                        }
                    }else {
                        if (message.senderUserId == 'system') {
                            if (message.content.message.content.content.type == 'gift') {
                                str = '<div class="gife"><p class="padding_10"><img class="bg_gife" src="' + message.content.message.content.content.data.img + '"/><img  src="__IMG2__/x.png"/><img src="__IMG2__/2.png"/></p></div>'
                            } else if (message.content.message.content.content.type == 'red_package') {
                                if(message.content.message.content.content.data.role_id == '{$info.role_id}'){
                                    str = '<div class="padding_10 mg_top10"><div class="clearfix text-center"><dl class="clearfix left width_100"><dt class="right"><img class="head" src="'+message.content.message.content.content.data.header_img+'"></dt><dd class="right padding_lr10"><div class="red-bag" onclick="getredPackage(this)" data-id="'+message.content.message.content.content.data.red_id+'" data-name="'+message.content.message.content.content.data.role_name+'" data-type="'+message.content.message.content.content.data.red_type+'" data-img="'+message.content.message.content.content.data.header_img+'" style="width: 200px;height: 70px;background: url(__IMG2__/redpackage-right.png)no-repeat;background-size:100% 100% ;position: relative;"><p class="color_ff redfont" style="margin: 0px 0 0 45px;padding-top: 10px;width: 150px;text-align: left;">'+message.content.message.content.content.data.msg+'</p><p class="color_ff redfont" style="margin: 0px 0 0 45px;font-size: 0.5rem;width: 150px;text-align: left;">查看红包</p><p class="redtext" style="position: absolute;bottom: 0px;left: 5px;font-size: 12px;color: #a9a9a9;">聊天室红包</p></div></dd></dl></div></div>';
                                }else{
                                    str = '<div class="padding_10 mg_top10"><div class="clearfix text-center"><dl class="clearfix left width_100"><dt class="left"><img class="head" src="'+message.content.message.content.content.data.header_img+'"></dt><dd class="left padding_lr10"><div class="red-bag left_redbag"  onclick="getredPackage(this)" data-id="'+message.content.message.content.content.data.red_id+'" data-name="'+message.content.message.content.content.data.role_name+'" data-type="'+message.content.message.content.content.data.red_type+'" data-img="'+message.content.message.content.content.data.header_img+'" style="width: 200px;height: 70px;background: url(__IMG2__/redpackage-left.png)no-repeat;position: relative;background-size:100% 100% ;"><p class="color_ff redfont" style="margin: 0px 0 0 45px;padding-top: 10px;width: 150px;text-align: left;">'+message.content.message.content.content.data.msg+'</p><p class="color_ff redfont" style="margin: 0px 0 0 45px;font-size: 0.5rem;width: 150px;text-align: left;">查看红包</p><p class="redtext" style="position: absolute;bottom: 0px;left: 5px;font-size: 12px;color: #a9a9a9;">聊天室红包</p></div></dd></dl></div></div>';
                                }
                            } else if (message.content.message.content.content.type == 'guess') {
                                str = '<p class="live-msg mg_top10"><i class="xi">系</i>' + message.content.message.content.content.data.role_name + '发出了一个红包 <img class="vertical-align_m" id="red" src="__IMG2__/msg_redbag.png" alt="" /></p>';
                            } else if (message.content.message.content.content.type == 'system') {
                                str = '<p><span>' + message.senderUserId + '：</span>' + message.content.content + '</p>';
                            } else if(message.content.message.content.content.type == 'play'){
                                if(is_owner != 1){
                                    layer.msg('主播已开启直播,2s后将跳转至直播间,是否立刻跳转?', {
                                        time: 0 //不自动关闭
                                        ,btn: ['确定']
                                        ,yes: function(index){
                                            // layer.close(index);
                                            history.go(0);
                                        }
                                    });
                                    setTimeout(function () {
                                        history.go(0);
                                    },2000);
                                }else{
                                    history.go(0);
                                }
                            }else if(message.content.message.content.content.type == 'ban'){
                                if(is_owner != 1 && is_admin != 1){
                                    $(".chat_msg").attr("readonly","readonly");
                                    $(".chat_msg").attr("placeholder","禁言中");
                                    $(".chat_msg").remove("id");
                                    $(".send_btn").remove("id");
                                }

                            }else if(message.content.message.content.content.type == 'remove'){
                                if(is_owner != 1 && is_admin != 1){
                                    $(".chat_msg").removeAttr("readonly");
                                    $(".chat_msg").attr("placeholder","");
                                    $(".chat_msg").attr("id",'msg');
                                    $(".send_btn").attr("id",'send');
                                }
                            }
                            if(str.length !=0){
                                $(".msg-chat").append(str);
                                $(".msg-chat").scrollTop($(".msg-chat")[0].scrollHeight);
                            }

                        }
                    }

                    //console.log('xxxxx');
                    // do something...
                    break;
                case RongIMClient.MessageType.VoiceMessage:
                    // //console.log(message);
                    // getVoice((message.content.duration), (message.content.content));

                    break;
                case RongIMClient.MessageType.PersonMessage:
                    // //console.log(message);
                    // getVoice((message.content.duration), (message.content.content));
                    var extra = eval('(' + message.content.extra + ')');
                    // var extra = message.content.extra;

                    var str = '<p class="live-msg mg_top10"><i class="xi">系</i><span class="blue">'+extra.nick_name+'</span> 进入直播间<img class="vertical-align_m" src="__IMG2__/msg_hores.png" alt="" /></p>';
                    $('.live-chate').append(str);
                    $(".live-chate").scrollTop($(".live-chate")[0].scrollHeight);

                    break;
                default:
                //console.log(message);

                // 自定义消息
                // do something...
            }
        }
    });









    screenFuc();
    function screenFuc() {
        var topHeight = $(".chatBox-head").innerHeight();//聊天头部高度
        //屏幕小于768px时候,布局change
        var winWidth = $(window).innerWidth();
        if (winWidth <= 768) {
            var totalHeight = $(window).height(); //页面整体高度
            $(".chatBox-info").css("height", totalHeight - topHeight);
            var infoHeight = $(".chatBox-info").innerHeight();//聊天头部以下高度
            //中间内容高度
            $(".chatBox-content").css("height", infoHeight - 46);
            $(".chatBox-content-demo").css("height", infoHeight - 46);

            $(".chatBox-list").css("height", totalHeight - topHeight);
            $(".chatBox-kuang").css("height", totalHeight - topHeight);
            $(".div-textarea").css("width", winWidth - 106);
        } else {
            $(".chatBox-info").css("height", 495);
            $(".chatBox-content").css("height", 448);
            $(".chatBox-content-demo").css("height", 448);
            $(".chatBox-list").css("height", 495);
            $(".chatBox-kuang").css("height", 495);
            $(".div-textarea").css("width", 260);
        }
    }

    (window.onresize = function () {
        screenFuc();
    })();
    //未读信息数量为空时
    var totalNum = $(".chat-message-num").html();
    if (totalNum == "") {
        $(".chat-message-num").css("padding", 0);
    }
    $(".message-num").each(function () {
        var wdNum = $(this).html();
        if (wdNum == "") {
            $(this).css("padding", 0);
        }
    });


    //打开/关闭聊天框
    $(".chatBtn").click(function () {
        $(".chatBox").toggle(10);
    })
    $(".chat-close").click(function () {
        $(".chatBox").toggle(10);
    })
    //进聊天页面
    $(".chat-list-people").each(function () {
        $(this).click(function () {
            var n = $(this).index();
            $(".chatBox-head-one").toggle();
            $(".chatBox-head-two").toggle();
            $(".chatBox-list").fadeToggle();
            $(".chatBox-kuang").fadeToggle();

            //传名字
            $(".ChatInfoName").text($(this).children(".chat-name").children("p").eq(0).html());

            //传头像
            $(".ChatInfoHead>img").attr("src", $(this).children().eq(0).children("img").attr("src"));

            //聊天框默认最底部
            $(document).ready(function () {
                $("#chatBox-content-demo").scrollTop($("#chatBox-content-demo")[0].scrollHeight);
            });
        })
    });

    //返回列表
    $(".chat-return").click(function () {
        $(".chatBox-head-one").toggle(1);
        $(".chatBox-head-two").toggle(1);
        $(".chatBox-list").fadeToggle(1);
        $(".chatBox-kuang").fadeToggle(1);
    });

    //      发送信息
    $("#chat-fasong").click(function () {
        var textContent = $(".div-textarea").html().replace(/[\n\r]/g, '<br>')
        if (textContent != "") {
            $(".chatBox-content-demo").append("<div class=\"clearfloat\">" +
                "<div class=\"author-name\"><small class=\"chat-date\">2017-12-02 14:26:58</small> </div> " +
                "<div class=\"right\"> <div class=\"chat-message\"> " + textContent + " </div> " +
                "<div class=\"chat-avatars\"><img src=\"/public/im/img/icon01.png\" alt=\"头像\" /></div> </div> </div>");
            //发送后清空输入框
            $(".div-textarea").html("");
            //聊天框默认最底部
            $(document).ready(function () {
                $("#chatBox-content-demo").scrollTop($("#chatBox-content-demo")[0].scrollHeight);
            });
        }
    });

    //      发送表情
    $("#chat-biaoqing").click(function () {
        $(".biaoqing-photo").toggle();
    });
    $(document).click(function () {
        $(".biaoqing-photo").css("display", "none");
    });
    $("#chat-biaoqing").click(function (event) {
        event.stopPropagation();//阻止事件
    });

    $(".emoji-picker-image").each(function () {
        $(this).click(function () {
            var bq = $(this).parent().html();
            console.log(bq)
            $(".chatBox-content-demo").append("<div class=\"clearfloat\">" +
                "<div class=\"author-name\"><small class=\"chat-date\">2017-12-02 14:26:58</small> </div> " +
                "<div class=\"right\"> <div class=\"chat-message\"> " + bq + " </div> " +
                "<div class=\"chat-avatars\"><img src=\"/public/im/img/icon01.png\" alt=\"头像\" /></div> </div> </div>");
            //发送后关闭表情框
            $(".biaoqing-photo").toggle();
            //聊天框默认最底部
            $(document).ready(function () {
                $("#chatBox-content-demo").scrollTop($("#chatBox-content-demo")[0].scrollHeight);
            });
        })
    });

    //      发送图片
    function selectImg(pic) {
        if (!pic.files || !pic.files[0]) {
            return;
        }
        var reader = new FileReader();
        reader.onload = function (evt) {
            var images = evt.target.result;
            $(".chatBox-content-demo").append("<div class=\"clearfloat\">" +
                "<div class=\"author-name\"><small class=\"chat-date\">2017-12-02 14:26:58</small> </div> " +
                "<div class=\"right\"> <div class=\"chat-message\"><img src=" + images + "></div> " +
                "<div class=\"chat-avatars\"><img src=\"/public/im/img/icon01.png\" alt=\"头像\" /></div> </div> </div>");
            //聊天框默认最底部
            $(document).ready(function () {
                $("#chatBox-content-demo").scrollTop($("#chatBox-content-demo")[0].scrollHeight);
            });
        };
        reader.readAsDataURL(pic.files[0]);

    }


</script>
{/block}