<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
    <title>soha</title>
    <link rel="stylesheet" href="__CSS__/css.css"/>
    <script src="__JS__/jquery-2.1.0.js"></script>
    <script src="__JS__/clipboard.min.js"></script>
    {include file="public/js" /}
</head>
<body class="hide">
<div class="video"  {if $room_info.play_status eq 0}style="height: 90%;"{/if}>

    <div id="video">

    </div>



    <div class="head">
        <a  class="back">
            <img src="__IMG__/back.png" alt=""/>
        </a>
        <!--<a  class="fxa">-->
            <!--<img src="__IMG__/bfx.png" alt=""/>-->
        <!--</a>-->
    </div>
    <!--<span class="hot">热度：{$data.hot}</span>-->
    <a class="stop" id="stop">
        <img src="__IMG__/ico-stop.png" alt=""/>
    </a>
    <!--<a class="stop" id="play">-->
        <!--<img src="__IMG__/ico-play.png" style="width: 16px" alt=""/>-->
    <!--</a>-->
    <!--<a class="stop window" id="window">-->
        <!--<img src="__IMG__/ico-all.png" alt=""/>-->
    <!--</a>-->
</div>

<div id="lt" class="room-n">
    <div class="room">
        <div class="room-txt">


        </div>
    </div>
    <div class="footer">

        <p>
        <span class="q">
            <span>
                <b onclick="location.href='{:url('wap/register',array('id'=>$id))}'">屏蔽礼物消息</b>
                <b onclick="location.href='{:url('wap/register',array('id'=>$id))}'">屏蔽广播</b>
            </span>
            <img src="__IMG__/do_03.png" alt=""/>
        </span>
            <a data-id="0" id="pb"><img src="__IMG__/icon001.png" alt=""/> </a>
            <input type="text" placeholder="文字" id="talk" onclick="location.href='{:url('wap/register',array('id'=>$id))}'"/>
            <!--<button id="send" style="display: none;">发送</button>-->
            <a href="{:url('wap/register',array('id'=>$id))}"><img src="__IMG__/icon03.png" alt=""/></a>
            <a href="{:url('wap/register',array('id'=>$id))}"><img src="__IMG__/icon04.png" alt=""/></a>
            <a href="{:url('wap/register',array('id'=>$id))}"><img src="__IMG__/icon05.png" alt=""/></a>
        </p>
    </div>

</div>

<script src="__JS__/js.js"></script>
<script src="__JS__/TcPlayer-2.2.2.js" charset="utf-8"></script>
<script src="//cdn.ronghub.com/RongIMLib-2.3.3.min.js"></script>
</body>
<script>

    var play_status = '{$room_info.play_status}';
    if(play_status){
        var player = new TcPlayer('video',{
            'live':true,
            "m3u8"      : "{$play_info.m3u8}",//原画
            "m3u8_hd"   : "{$play_info.m3u8_hd}",//高清
            "m3u8_sd"   : "{$play_info.m3u8_sd}",//标清
            "autoplay"  : true,      //iOS下safari浏览器，以及大部分移动端浏览器是不开放视频自动播放这个能力的
            "coverpic"  : "{$play_info.img}",//封面地址
            "clarityLabel" : {
                od: '原画', hd: '高清', sd: '标清'//清晰度切换标签
            },
            "clarity" : 'od',//默认清晰度
            "width"   : '500',//视频的显示宽度，请尽量使用视频分辨率宽度
            "height"  : '250'//视频的显示高度，请尽量使用视频分辨率高度
        });
        var status = player.fullscreen();
        $('.vcp-fullscreen-toggle').click(function () {
            console.log(status);
        });
    }




    $(function(){
        $('#pb').click(function(){
            var id = $(this).attr('data-id');
            if(id == 0){
                $('.q').show();
                $(this).attr('data-id',1);
            }else{
                $('.q').hide();
                $(this).attr('data-id',0);
            }

        })

        var he = $('body').innerHeight()-$('.video').innerHeight()-46-50;
        $('.room').css({height:he+'px'});
        $('.room-zb').css({height:he+50+'px'});
        var video = document.getElementById('video');
        $('#play').click(function(){
            video.play();
            $(this).hide();
            $('#stop').show();
        })
        $('#stop').click(function(){
            video.pause();
            $(this).hide();
            $('#play').show();
        });
    });
    $('.video-list p').click(function(){
        $(this).addClass('active');
        $(this).siblings().removeClass('active');
        var type = "#"+$(this).attr('data-type');
        $('.room-n').hide();
        $(type).show();
//        switch (type){
//            case 'lt': $('#lt').show(); break;
//            case 'zb': $('#zb').show(); break;
//            case 'hf': $('#hf').show(); break;
//            case 'cy': $('#cy').show(); break;
//        }
    })
    $('.fxa').click(function(){
        $('.meng').show();
    })
    $('.off').click(function(){
        $('.meng').hide();
    })


    var params = {
        appKey :"{:config('rongyun.appKey')}",
        token : "{$token}",
    };
    var callbacks = {

    };

    init(params,callbacks);
    // RongIMLib.RongIMClient.init('m7ua80gbmjrnm');
    // var token = "{$data.r_token}";
    function init(params, callbacks, modules){
        var appKey = params.appKey;
        var token = params.token;
        var navi = params.navi || "";

        modules = modules || {};
        var RongIMLib = modules.RongIMLib || window.RongIMLib;
        var RongIMClient = RongIMLib.RongIMClient;
        var protobuf = modules.protobuf || null;

        var config = {};

        //私有云切换navi导航，私有云格式 '120.92.10.214:8888'
        if(navi !== ""){
            config.navi = navi;
        }

        //私有云切换api,私有云格式 '172.20.210.38:81:8888'
        var api = params.api || "";
        if(api !== ""){
            config.api = api;
        }

        //support protobuf url + function
        if(protobuf != null){
            config.protobuf = protobuf;
        };


        RongIMLib.RongIMClient.init(appKey,null,config);

        //
        // /*
        //  文档：http://www.rongcloud.cn/docs/web.html#3、设置消息监听器
        //
        //  注意事项：
        //  1：为了看到接收效果，需要另外一个用户向本用户发消息
        //  2：判断会话唯一性 ：conversationType + targetId
        //  3：显示消息在页面前，需要判断是否属于当前会话，避免消息错乱。
        //  4：消息体属性说明可参考：http://rongcloud.cn/docs/api/js/index.html
        //  */


        var instance = RongIMClient.getInstance();

        // 连接状态监听器
        RongIMClient.setConnectionStatusListener({
            onChanged: function (status) {

                // console.log(status);
                switch (status) {
                    case RongIMLib.ConnectionStatus["CONNECTED"]:
                    case 0:
                        console.log("连接成功")
                        callbacks.getInstance && callbacks.getInstance(instance);
                        break;

                    case RongIMLib.ConnectionStatus["CONNECTING"]:
                    case 1:
                        console.log("连接中")
                        break;

                    case RongIMLib.ConnectionStatus["DISCONNECTED"]:
                    case 2:
                        console.log("当前用户主动断开链接")
                        break;

                    case RongIMLib.ConnectionStatus["NETWORK_UNAVAILABLE"]:
                    case 3:
                        console.log("网络不可用")
                        break;

                    case RongIMLib.ConnectionStatus["CONNECTION_CLOSED"]:
                    case 4:
                        console.log("未知原因，连接关闭")
                        break;

                    case RongIMLib.ConnectionStatus["KICKED_OFFLINE_BY_OTHER_CLIENT"]:
                    case 6:
                        console.log("用户账户在其他设备登录，本机会被踢掉线")
                        break;

                    case RongIMLib.ConnectionStatus["DOMAIN_INCORRECT"]:
                    case 12:
                        console.log("当前运行域名错误，请检查安全域名配置")
                        break;
                }
            }
        });



        //开始链接
        var userid;
        if(play_status == 1){
            var chatRoomId = "{$room_info.chat_id_play}"; // 聊天室 Id。
        }else{
            var chatRoomId = "{$room_info.chat_id}"; // 聊天室 Id。
        }
        console.log(chatRoomId);
        console.log('test');
        RongIMClient.connect(token, {
            onSuccess: function(userId) {
                callbacks.getCurrentUser && callbacks.getCurrentUser({userId:userId});
                console.log("链接成功，用户id：" + userId);
                userid=userId;
                var conversationtype = RongIMLib.ConversationType.CHATROOM;
                var count =0;
                RongIMClient.getInstance().joinChatRoom(chatRoomId, count, {
                    onSuccess: function() {
                        console.log(chatRoomId);
                        // 加入聊天室成功。
                        console.log('加入聊天室成功。');

                        var order = RongIMLib.GetChatRoomType.REVERSE;// 排序方式。
                        RongIMClient.getInstance().getChatRoomInfo(chatRoomId, count, order, {
                            onSuccess: function(chatRoom) {
                                // chatRoom => 聊天室信息。
                                // chatRoom.userInfos => 返回聊天室成员。
                                // chatRoom.userTotalNums => 当前聊天室总人数。
                                console.log(chatRoom.userInfos);
                                console.log(chatRoom.userTotalNums);
                            },

                            onError: function(error) {
                                // 获取聊天室信息失败。
                            }
                        });
                    },
                    onError: function(error) {
                        // 加入聊天室失败
                        console.log('加入聊天室失败。');
                    }
                });
                // sendMessage('xxxx',chatRoomId);

            },
            onTokenIncorrect: function() {
                console.log('token无效');
            },
            onError:function(errorCode){
                console.log(errorCode);
            }
        });}

// 发送消息相关参数说明
var conversationtype = RongIMLib.ConversationType.CHATROOM;
/*
PRIVATE 为单聊、
GROUP 为群组、
CHATROOM 为聊天室、
CUSTOMER_SERVICE 为客服、
SYSTEM 为系统消息、
APP_PUBLIC_SERVICE 为应用公众账号（应用内私有）、
PUBLIC_SERVICE 为公众账号 (公有)
*/

    if(play_status == 1){
        var targetId = "{$room_info.chat_id_play}"; // 目标 Id，根据不同的 ConversationType，可能是用户 Id、群组 Id。
    }else{
        var targetId = "{$room_info.chat_id}"; // 目标 Id，根据不同的 ConversationType，可能是用户 Id、群组 Id。
    }

    function sendMessage(msg) {

        RongIMClient.getInstance().sendMessage(conversationtype, targetId, msg, {
            // 发送消息成功
            onSuccess: function (message) {
                var str = '<p><span>'+message.content.extra.nick_name+'：</span>'+message.content.content+'</p>';
                $('.room-txt').append(str);
                // getMessage();
                // console.log(message)
                //message 为发送的消息对象并且包含服务器返回的消息唯一Id和发送消息时间戳
                // console.log("Send successfully");
            },
            onError: function (errorCode, message) {
                var info = '';
                switch (errorCode) {
                    case RongIMLib.ErrorCode.TIMEOUT:
                        info = '超时';
                        break;
                    case RongIMLib.ErrorCode.UNKNOWN_ERROR:
                        info = '未知错误';
                        break;
                    case RongIMLib.ErrorCode.REJECTED_BY_BLACKLIST:
                        info = '在黑名单中，无法向对方发送消息';
                        break;
                    case RongIMLib.ErrorCode.NOT_IN_DISCUSSION:
                        info = '不在讨论组中';
                        break;
                    case RongIMLib.ErrorCode.NOT_IN_GROUP:
                        info = '不在群组中';
                        break;
                    case RongIMLib.ErrorCode.NOT_IN_CHATROOM:
                        info = '不在聊天室中';
                        break;
                    default:
                        info = "x";
                        break;
                }
                console.log('发送失败:' + info);
            }
        });
    }
    // function getMessage() {
    RongIMClient.setOnReceiveMessageListener({
        // 接收到的消息
        onReceived: function(message) {

            // 判断消息类型
            console.log('messageContent:');

            console.log(message);

            switch (message.messageType) {
                case RongIMClient.MessageType.TextMessage:
                    // //console.log(message.content.content)
                    // //console.log('yyyy');
                    var extra = eval('(' + message.content.extra + ')');
                    // var extra = message.content.extra;
                    if(status == 1){
                        var str = '<p class="live-msg mg_top10"><span class="blue">'+extra.nick_name+':</span>'+message.content.content+' </p>';
                        $('.room-txt').append(str);
                    }else{
                        var str = '<div class="padding_10 mg_top10"><div class="clearfix"><dl class="clearfix left"><dt class="left"><img class="head" src="'+extra.header_img+'"></dt><dd class="left padding_lr10"><p><strong>'+extra.nick_name+'</strong></p><p class="mg_top5">'+message.content.content+'</p></dd></dl></div></div>';
                        //发送的消息内容将会被打印
                        $('.room-txt').append(str);
                    }

                    // answers(message.content.content,message.senderUserId);
                    break;
                case RongIMClient.MessageType.ImageMessage:
                    var extra = message.content.user;
                    // var extra = message.content.extra;
                    if(status == 1){
                        var str = '<img src="'+message.content.imageUri+'">';
                        $('.live-chate').append(str);
                    }else{
                        var str = '<div class="padding_10 mg_top10"><div class="clearfix"><dl class="clearfix left"><dt class="left"><img class="head" src="'+extra.portrait+'"></dt><dd class="left padding_lr10"><p><strong>'+extra.name+'</strong></p><p class="mg_top5">'+message.content.imageUri+'</p></dd></dl></div></div>';
                        $('.msg-chat').append(str);
                    }
                    // do something...
                    break;
                case RongIMClient.MessageType.DiscussionNotificationMessage:

                    // do something...
                    break;
                case RongIMClient.MessageType.LocationMessage:

                    // do something...
                    break;
                case RongIMClient.MessageType.RichContentMessage:

                    // do something...
                    break;
                case RongIMClient.MessageType.DiscussionNotificationMessage:

                    // do something...
                    break;
                case RongIMClient.MessageType.InformationNotificationMessage:
                    // do something...
                    break;
                case RongIMClient.MessageType.ContactNotificationMessage:
                    // do something...
                    break;
                case RongIMClient.MessageType.ProfileNotificationMessage:
                    // do something...
                    break;
                case RongIMClient.MessageType.CommandNotificationMessage:
                    // do something...
                    break;
                case RongIMClient.MessageType.CommandMessage:
                    // do something...
                    break;
                case RongIMClient.MessageType.UnknownMessage:
                    if(status == 1){
                        if(message. senderUserId== 'system'){
                            if(message.content.message.content.content.type == 'gift' ){
                                if ((gift_status != 1)) return false;
                                var st = '';
                                for(var i=0;i<message.content.message.content.content.data.num.length;i++){
                                    st += '<img src="__IMG2__/'+message.content.message.content.content.data.num[i]+'.png"/>';
                                }
                                var str = '<p class="padding_10"><img class="bg_gife" style="width: 36px;" src="'+message.content.message.content.content.data.img+'"/><img  src="__IMG2__/x.png"/>'+st+'</p>';
                                $(".gife").html(str);
                                $(".gife").css('display','block');
                                $('.gife').addClass('animated slideInRight');
                                setTimeout(function(){
                                    $('.gife').removeClass('slideInRight');

                                }, 1000);
                                $('.gife').delay(1000).fadeOut(200);
                                return false;
                            }else if(message.content.message.content.content.type == 'red_package'){
                                if ((system_status != 1)) return false;
                                var str = '<p class="live-msg mg_top10"><i class="xi">系</i>'+message.content.message.content.content.data.role_name+'发出了一个红包 <img class="vertical-align_m" id="red" src="__IMG2__/msg_redbag.png" alt=""  onclick="getredPackage(this)" data-id="'+message.content.message.content.content.data.red_id+'" data-name="'+message.content.message.content.content.data.role_name+'" data-type="'+message.content.message.content.content.data.red_type+'" data-img="'+message.content.message.content.content.data.header_img+'"/></p>';
                            }else if(message.content.message.content.content.type == 'guess'){
                                if ((system_status != 1)) return false;
                                var str = '<p class="live-msg mg_top10"><i class="xi">系</i><span class="green">房主发起了一次竞猜</span><img class="vertical-align_m" src="__IMG2__/msg_tv.png" alt="" /></p>';
                            }else if(message.content.message.content.content.type == 'system'){
                                if ((system_status != 1)) return false;
                                var str = '<p class="live-msg mg_top10"><i class="xi">系</i><span class="green">'+message.content.message.content.content.data+'</span><img class="vertical-align_m" src="__IMG2__/msg_tv.png" alt="" /></p>';

                            }else{

                            }
                            $(".room-txt").append(str);
                        }
                    }else {
                        if (message.senderUserId == 'system') {
                            if (message.content.message.content.content.type == 'gift') {
                                var str = '<div class="gife"><p class="padding_10"><img class="bg_gife" src="' + message.content.message.content.content.data.img + '"/><img  src="__IMG2__/x.png"/><img src="__IMG2__/2.png"/></p></div>'
                            } else if (message.content.message.content.content.type == 'red_package') {
                                if(message.content.message.content.content.data.role_id == '{$info.role_id}'){
                                    var str = '<div class="padding_10 mg_top10"><div class="clearfix text-center"><dl class="clearfix left width_100"><dt class="right"><img class="head" src="'+message.content.message.content.content.data.header_img+'"></dt><dd class="right padding_lr10"><div class="red-bag" onclick="getredPackage(this)" data-id="'+message.content.message.content.content.data.red_id+'" data-name="'+message.content.message.content.content.data.role_name+'" data-type="'+message.content.message.content.content.data.red_type+'" data-img="'+message.content.message.content.content.data.header_img+'" style="width: 200px;height: 70px;background: url(__IMG2__/redpackage-right.png)no-repeat;background-size:100% 100% ;position: relative;"><p class="color_ff redfont" style="margin: 0px 0 0 45px;padding-top: 10px;width: 150px;text-align: left;">'+message.content.message.content.content.data.msg+'</p><p class="color_ff redfont" style="margin: 0px 0 0 45px;font-size: 0.5rem;width: 150px;text-align: left;">查看红包</p><p class="redtext" style="position: absolute;bottom: 0px;left: 5px;font-size: 12px;color: #a9a9a9;">聊天室红包</p></div></dd></dl></div></div>';
                                }else{
                                    var str = '<div class="padding_10 mg_top10"><div class="clearfix text-center"><dl class="clearfix left width_100"><dt class="left"><img class="head" src="'+message.content.message.content.content.data.header_img+'"></dt><dd class="left padding_lr10"><div class="red-bag left_redbag"  onclick="getredPackage(this)" data-id="'+message.content.message.content.content.data.red_id+'" data-name="'+message.content.message.content.content.data.role_name+'" data-type="'+message.content.message.content.content.data.red_type+'" data-img="'+message.content.message.content.content.data.header_img+'" style="width: 200px;height: 70px;background: url(__IMG2__/redpackage-left.png)no-repeat;position: relative;background-size:100% 100% ;"><p class="color_ff redfont" style="margin: 0px 0 0 45px;padding-top: 10px;width: 150px;text-align: left;">'+message.content.message.content.content.data.msg+'</p><p class="color_ff redfont" style="margin: 0px 0 0 45px;font-size: 0.5rem;width: 150px;text-align: left;">查看红包</p><p class="redtext" style="position: absolute;bottom: 0px;left: 5px;font-size: 12px;color: #a9a9a9;">聊天室红包</p></div></dd></dl></div></div>';
                                }
                            } else if (message.content.message.content.content.type == 'guess') {
                                var str = '<p class="live-msg mg_top10"><i class="xi">系</i>' + message.content.message.content.content.data.role_name + '发出了一个红包 <img class="vertical-align_m" id="red" src="__IMG2__/msg_redbag.png" alt="" /></p>';
                            } else if (message.content.message.content.content.type == 'system') {
                                var str = '<p><span>' + message.senderUserId + '：</span>' + message.content.content + '</p>';
                            } else {

                            }
                            $(".room-txt").append(str);
                        }
                    }

                    //console.log('xxxxx');
                    // do something...
                    break;
                case RongIMClient.MessageType.VoiceMessage:
                    // //console.log(message);
                    // getVoice((message.content.duration), (message.content.content));

                    break;
                case RongIMClient.MessageType.PersonMessage:
                    // //console.log(message);
                    // getVoice((message.content.duration), (message.content.content));
                    var extra = eval('(' + message.content.extra + ')');
                    // var extra = message.content.extra;

                    var str = '<p class="live-msg mg_top10"><i class="xi">系</i><span class="blue">'+extra.nick_name+'</span> 进入直播间<img class="vertical-align_m" src="__IMG2__/msg_hores.png" alt="" /></p>';
                    $('.room-txt').append(str);
                    break;
                default:
                //console.log(message);

                // 自定义消息
                // do something...
            }
        }
    });
</script>
</html>